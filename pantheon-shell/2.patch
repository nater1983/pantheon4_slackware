From cb1176bca8ac84c08f6c2cc62654516c5447a6bb Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Danielle=20For=C3=A9?= <danielle@elementary.io>
Date: Tue, 13 Jun 2023 10:17:10 -0700
Subject: [PATCH] Add optional Wayland session (#66)

---
 meson.build                               |  4 ++++
 meson_options.txt                         |  3 +++
 session/meson.build                       | 18 ++++++++++++++++++
 session/pantheon-wayland.session.in       |  5 +++++
 wayland-sessions/meson.build              |  4 ++++
 wayland-sessions/pantheon-wayland.desktop |  8 ++++++++
 6 files changed, 42 insertions(+)
 create mode 100644 session/pantheon-wayland.session.in
 create mode 100644 wayland-sessions/meson.build
 create mode 100644 wayland-sessions/pantheon-wayland.desktop

diff --git a/meson.build b/meson.build
index 41804c3..cf95302 100644
--- a/meson.build
+++ b/meson.build
@@ -15,3 +15,7 @@ subdir('xsessions')
 if get_option('systemd')
     subdir('systemd')
 endif
+
+if get_option('wayland')
+    subdir('wayland-sessions')
+endif
diff --git a/meson_options.txt b/meson_options.txt
index 2ae76a7..9734566 100644
--- a/meson_options.txt
+++ b/meson_options.txt
@@ -12,3 +12,6 @@ option('systemd', type: 'boolean', value: true,
 
 option('systemduserunitdir', type: 'string', value: '',
        description : 'Custom directory for systemd user units')
+
+option('wayland', type: 'boolean', value: false,
+       description: 'Install Wayland session')
diff --git a/session/meson.build b/session/meson.build
index d1474e4..221560a 100644
--- a/session/meson.build
+++ b/session/meson.build
@@ -66,6 +66,24 @@ pantheon_session = configure_file(
   install_dir: join_paths(datadir, 'gnome-session', 'sessions')
 )
 
+if get_option('wayland')
+    wayland_session_components = [
+      'gala-wayland',
+      'gala-daemon',
+      gsd_components
+    ]
+
+    wayland_session_configuration = configuration_data()
+    wayland_session_configuration.set('SESSION_COMPONENTS', ';'.join(wayland_session_components))
+
+    configure_file(
+      input: 'pantheon-wayland.session.in',
+      output: '@BASENAME@',
+      configuration: wayland_session_configuration,
+      install_dir: datadir / 'gnome-session' / 'sessions'
+    )
+endif
+
 autostartdir = join_paths(get_option('sysconfdir'), 'xdg', 'autostart')
 
 gsd_dir = gsd_dep.get_pkgconfig_variable('prefix')
diff --git a/session/pantheon-wayland.session.in b/session/pantheon-wayland.session.in
new file mode 100644
index 0000000..bdfa8e5
--- /dev/null
+++ b/session/pantheon-wayland.session.in
@@ -0,0 +1,5 @@
+[GNOME Session]
+Name=Pantheon (Wayland)
+RequiredComponents=@SESSION_COMPONENTS@
+FallbackSession=pantheon
+DesktopName=Pantheon
diff --git a/wayland-sessions/meson.build b/wayland-sessions/meson.build
new file mode 100644
index 0000000..41e4043
--- /dev/null
+++ b/wayland-sessions/meson.build
@@ -0,0 +1,4 @@
+install_data(
+    'pantheon-wayland.desktop',
+    install_dir: datadir / 'wayland-sessions'
+)
diff --git a/wayland-sessions/pantheon-wayland.desktop b/wayland-sessions/pantheon-wayland.desktop
new file mode 100644
index 0000000..e6315f4
--- /dev/null
+++ b/wayland-sessions/pantheon-wayland.desktop
@@ -0,0 +1,8 @@
+[Desktop Entry]
+Name=Pantheon (Wayland)
+Comment=This session provides elementary experience
+Exec=gnome-session --builtin --session=pantheon-wayland
+TryExec=io.elementary.wingpanel
+Icon=
+DesktopNames=Pantheon
+Type=Application
